default:
  image: node:16

stages:
  - install
  - test
  - deploy

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

.client:
  cache:
    - &client_node_modules_cache
      key:
        files:
          - client/package-lock.json
      paths:
        - client/node_modules/
      policy: pull
  before_script:
    - cd client
.server:
  cache:
    - &server_node_modules_cache
      key:
        files:
          - server/package-lock.json
      paths:
        - server/node_modules/
      policy: pull
  before_script:
    - cd server

install-client:
  extends: .client
  stage: install
  script:
    - npm ci --cache .npm --prefer-offline
  cache:
    - <<: *client_node_modules_cache
      policy: pull-push
    - key: $CI_JOB_NAME
      paths:
        - client/.npm/
install-server:
  extends: .server
  stage: install
  script:
    - npm ci --cache .npm --prefer-offline
  cache:
    - <<: *server_node_modules_cache
      policy: pull-push
    - key: $CI_JOB_NAME
      paths:
        - server/.npm/

.format:
  stage: test
  script:
    - npm run format:check
format-client:
  extends:
    - .client
    - .format
format-server:
  extends:
    - .server
    - .format

.lint:
  stage: test
  script:
    - npm run lint
lint-client:
  extends:
    - .client
    - .lint
lint-server:
  extends:
    - .server
    - .lint

test-client:
  extends:
    - .client
  stage: test
  image: timbru31/node-chrome:16
  needs: [install-client]
  script:
    - npm test -- --no-watch --no-progress --browsers=ChromeHeadlessNoSandbox
test-server:
  extends:
    - .server
  stage: test
  needs: [install-server]
  script:
    - npm test

# build:client:
#     stage: build
#     script:
#         - pushd client
#         - npm run build
#         - popd
#     artifacts:
#         paths:
#             - client/dist/
# build:server:
#     stage: build
#     script:
#         - pushd server
#         - npx tsc
#         - popd
#     artifacts:
#         paths:
#            - server/out/
